# Geomesa Database
<img width="38" alt="Screen Shot 2023-05-07 at 09 56 05" src="https://user-images.githubusercontent.com/71087982/236662661-c9baf439-6032-437d-b376-1f45729213cc.png">  

GeoMesa - это лицензированный Apache набор инструментов с открытым исходным кодом, который обеспечивает крупномасштабную геопространственную аналитику в распределенных вычислительных системах, позволяя вам управлять и анализировать огромные пространственно-временные наборы данных, которыми сегодня стремятся воспользоваться приложения Интернета Вещей, социальных сетей, отслеживания и мобильных телефонов.  
Основой для хранения массивных наборов данных являются распределенные колоночные типы хранения, такие как Accumulo, HBase, Google Bigtable. Это позволяет быстро обращаться к этим данным через запросы с использованием расстояний и площадей. GeoMesa также обеспечивает поддержку потоковой обработки пространственно-временных данных почти в реальном времени путем наложения пространственной семантики поверх системы обмена сообщениями Apache Kafka.  
С помощью сервера географической информации, такого как GeoServer, GeoMesa облегчает интеграцию с широким спектром существующих картографических клиентов, предоставляя доступ к своим базам данных и возможностям потоковой передачи данных через стандартные API OGC (Open Geospatial Consortium) и протоколы, такие как WFS и WMS. Эти интерфейсы также позволяют GeoMesa предоставлять данные для аналитики, такие как запросы, гистограммы, тепловые карты и анализ временных рядов.
  
## История
Пространственно-временные данные имеют огромную ценность, но структурировать большие объемы этих данных таким образом, чтобы их можно было эффективно запрашивать, сложно. Первоначально GA-CCRi разработала GeoMesa в качестве платформы для инструментов анализа и визуализации, поддерживающих систему пространственного прогнозирования угроз, используемую армией США для прогнозирования местоположения событий асимметричной войны в Афганистане. После использования инструмента для поддержки нескольких наших собственных несвязанных аналитических систем мы осознали ценность системы для сообщества и решили использовать технологию с открытым исходным кодом.

## Возможности
Функции GeoMesa включают в себя возможность:
* Хранить от гигабайт до петабайт пространственных данных (десятки миллиардов точек и более)
* Обрабатывайте данные быстрее, чем 10 000 записей в секунду на узел
* Простое горизонтальное масштабирование (добавить больше серверов, чтобы увеличить пропускную способность)
* Поддержка Spark analytics
* Управлять картой через GeoServer или другие клиенты OGC  

Существует множество причин, по которым GeoMesa может предоставить наилучшее решение для удовлетворения потребностей в пространственно-временных базах данных:
* У вас большие наборы пространственных данных, и вы достигаете ограничений производительности реляционных систем баз данных. Возможно, вы изучаете стратегии сегментирования и задаетесь вопросом, не пришло ли сейчас время искать новое решение для хранения данных.
* У вас очень высокоскоростные данные, и вам нужны высокие скорости чтения и записи.
* Ваша аналитика работает в облаке, возможно, с использованием Spark, и вы хотите включить пространственную аналитику.
* Вы ищете поддерживаемую альтернативу дорогим проприетарным решениям с открытым исходным кодом.
* Вы ищете базу данных Platform as a Service (PaaS), в которой вы могли бы хранить большие пространственные данные.
* Вы хотите отфильтровать данные с помощью Common Query Language (CQL), определенного OGC.

## Инструменты взаимодействия

Если вы хотите просматривать потоковые данные почти в режиме реального времени, то рассмотрите возможность использования Kafka или Redis.
В противном случае вы можете получить аналогичную функциональность с помощью HBase, Accumulo или Cassandra. HBase и Accumulo поддерживают распределенную обработку, поэтому некоторые операции могут выполняться быстрее. HBase и Cassandra являются наиболее широко используемыми технологиями, в то время как Accumulo часто выбирают за его расширенные функции безопасности.
Другим вариантом является хранилище данных файловой системы (HDFS), которое имеет очень низкий барьер для входа и может считывать существующие данные в различных форматах файлов. Хранилище данных файловой системы может обеспечить чрезвычайно недорогое хранилище при поддержке облачных хранилищ объектов^ однако, как правило, оно не так производительно, как при использовании реальной базы данных.  
В расширенных вариантах использование несколько хранилищ можно объединить с помощью комбинированных представлений хранилища данных, чтобы обеспечить как высокую производительность (для последних данных), так и низкую стоимость (для старых данных).  
Какое бы решение для хранения данных вы ни выбрали, GeoMesa API остается неизменным (за исключением некоторых параметров конфигурации, специфичных для серверной части). Для большинства пользователей серверную часть можно заменить с минимальными изменениями кода.  
Для работы с Geomesa необходимо иметь:  
* Java JDK > 1.8
* Apache Maven 3.6 or later
* GitHub
* Redis

## Database engine

## Разворачивание Geomesa Redis

## Хранилища данных
Хранилища данных, которые GeoMesa использует для долгосрочного хранения, представляют собой базы данных "ключ-значение", тип базы данных NoSQL, в которой каждая запись хранится и извлекается с использованием уникального идентификатора для этой записи, известного как ключ. Accumulo и HBase сортируют эти ключи и могут хранить их на любом количестве узлов (серверов).
При использовании базы данных ключ-значение хороший дизайн самих ключей может привести к созданию более эффективных приложений. В отличие от реляционных баз данных, где ключами часто являются последовательные целые числа, хранилища значений ключей обычно используют ключ для представления функции, с помощью которой часто запрашиваются данные.  
Это упрощение того, как на самом деле работают структуры ключей Accumulo и HBase, но основополагающий принцип GeoMesa можно объяснить в терминах ключей и значений. Чтобы сохранить пространственно-временные данные, нам нужно создать ключ, который представляет местоположение записи во времени/пространстве. GeoMesa использует эту систему для сохранения местоположений в виде точек вдоль специальной линии, которая пересекает все сектора карты, например, красную линию, показанную здесь:  
<img width="691" alt="Screen Shot 2023-05-07 at 09 57 37" src="https://user-images.githubusercontent.com/71087982/236662744-0a9f0468-d639-4252-b6a5-1b2299d8e4d3.png">  

Эта красная линия известна как кривая заполнения пространства, или, если быть более точным, Z-кривая. Эта строка посещает каждую ячейку ровно один раз, устанавливая уникальный порядок ячеек.  
Каждой точке на этой кривой может быть присвоено последовательное значение, что позволяет GeoMesa представлять то, что могло бы быть парой широта-долгота, в виде одного целого числа. Это отлично подходит для представления двумерных данных в одномерном ключе, как в случае с хранилищем данных ключ-значение. Что еще более важно, эти кривые заполнения пространства могут быть адаптированы для n измерений, позволяя GeoMesa линеаризовать n измерений данных в одном измерении.  
Основной принцип индекса GeoMesa заключается в представлении трех измерений долготы, широты и времени с помощью трехмерной кривой заполнения пространства, используя значения точек вдоль этой кривой в качестве ключа. Это позволяет сохранять запись в хранилище ключ-значение с ключом, представляющим три измерения данных, которые мы чаще всего используем для запросов.
Фактическая структура ключа более сложна, чем простая пара ключ-значение. Ниже приведено более подробное представление индексного ключа GeoMesa:  
<img width="706" alt="Screen Shot 2023-05-07 at 09 57 46" src="https://user-images.githubusercontent.com/71087982/236662750-677c6064-028b-4736-b0c3-e02c5e3eeee7.png">. 


## Транзакции  
Некоторые хранилища данных поддерживают транзакции, которые могут быть использованы для изоляции группы операций. GeoMesa не поддерживает транзакции, поэтому по умолчанию используется транзакция GeoTools (Основной абстракцией в GeoMesa является хранилище данных GeoTools. Это интеграция с GeoMesa с помощью кода). Используется функция Transaction.AUTO_COMMIT. Как правило, после успешного закрытия записи данные сохраняются в базовом хранилище. До тех пор данные могут кэшироваться и буферизоваться локально и могут быть недоступны для запроса.

## Язык программирование:
Scala

## Типы индекса и пример создания:
GeoMesa использует ряд различных индексов для удовлетворения различных поисковых предикатов. Каждый индекс имеет идентификатор (в скобках), который используется для ссылки на него в параметрах конфигурации.
По умолчанию GeoMesa создаст несколько индексов на основе геометрии и даты по умолчанию. Для расширенных вариантов использования индексы могут быть заданы с помощью настройки создания индекса.
* **z2**  - индекс Z2 использует двумерную кривую Z-порядка для индексации широты и долготы для точечных данных. Этот индекс будет создан, если тип объекта имеет тип геометрии Point. Это используется для эффективного ответа на запросы с пространственным компонентом, но без временного компонента.
* **z3** - индекс Z3 использует трехмерную кривую Z-порядка для индексации широты, долготы и времени для точечных данных. Этот индекс будет создан, если тип объекта имеет тип геометрии Point и атрибут date. Это используется для эффективного ответа на запросы как с пространственными, так и с временными компонентами.
* **xz2** - индекс XZ2 использует двумерную реализацию XZ-порядка 1 для индексации широты и долготы для неточечных данных. XZ-упорядочение - это расширение Z-упорядочения, предназначенное для пространственно протяженных объектов (т.е. неточечных геометрий, таких как линейные цепочки или многоугольники). Этот индекс будет создан, если тип объекта имеет неточечную геометрию. Это используется для эффективного ответа на запросы с пространственным компонентом, но без временного компонента.
* **xz3** - индекс XZ3 использует трехмерную реализацию XZ-порядка 1 для индексации широты, долготы и времени для неточечных данных. Этот индекс будет создан, если тип объекта имеет неточечную геометрию и атрибут даты. Это используется для эффективного ответа на запросы как с пространственными, так и с временными компонентами.
* **id** - индекс ID использует идентификатор объекта в качестве первичного ключа. Он используется для любого запроса по идентификатору. Кроме того, некоторые запросы атрибутов могут в конечном итоге извлекать данные из индекса идентификатора.
* **attr** - индекс атрибута использует значения атрибута в качестве основного ключа индекса. Это позволяет быстро извлекать запросы без пространственно-временной составляющей. Индекс атрибута включает в себя вторичный пространственно-временной ключ, который может улучшить запросы с несколькими предикатами.

## Шардирование
GeoMesa позволяет настраивать количество шардов (или разбиений), на которые делятся индексы Z2/Z3/XZ2/XZ3. Этот параметр может быть изменен индивидуально для каждого SimpleFeatureType. Если ничего не указано, GeoMesa по умолчанию будет иметь значение 4 фрагмента. Количество сегментов должно быть от 1 до 127.  
Шарды позволяют предварительно разбивать таблицы, что обеспечивает некоторый начальный параллелизм при чтении и записи. По мере записи большего количества данных таблицы, как правило, будут разделяться в зависимости от размера, что устраняет необходимость в явных шардах. Установка слишком большого количества шардов может снизить производительность, поскольку для каждого запроса требуется выполнять больше вычислений.  
Количество шардов задается при вызове createSchema. Это может быть задано с помощью простых пользовательских данных типа объекта, используя geomesa.z2.splits или geomesa.z3.splits для двух и трехмерных индексов соответственно

## Индексация по времени
GeoMesa использует индекс z-кривой для запросов, основанных на времени. По умолчанию время разбивается на недельные блоки и индексируется по неделям. Если ваши запросы обычно намного больше или меньше одной недели, вы можете захотеть разделить их с другим интервалом. GeoMesa предоставляет четыре интервала - день, неделю, месяц или год. По мере увеличения интервала для запроса необходимо проверять меньшее количество разделов, но точность каждого интервала будет снижаться.  
Если вы обычно запрашиваете данные за несколько месяцев, то индексация за месяц может обеспечить более высокую производительность. В качестве альтернативы, если вы обычно запрашиваете данные объемом в несколько минут за раз, индексация в день может быть быстрее. Разбивка по умолчанию на недели, как правило, обеспечивает хороший баланс для большинства сценариев. Обратите внимание, что оптимальное разделение зависит от шаблонов запросов, а не от распределения данных.

## Безопасность
GeoMesa поддерживает безопасность данных за счет использования меток видимости для обеспечения доступа к конфиденциальным данным. Чтобы предотвратить утечку данных, схему можно настроить таким образом, чтобы она отклоняла любые записи, которые не содержат допустимых отображений. Чтобы включить этот параметр, используйте ключ пользовательских данных geomesa.vis.required.  
Обратите внимание, что эта конфигурация предотвратит отсутствие меток видимости в обычных путях записи, но по-прежнему возможно записывать данные без меток через старые клиенты, массовую загрузку или прямой доступ к базовой базе данных.  
Возможности видимости изначально были частью Apache Accumulo, а позже были приняты Apache HBase. GeoMesa поддерживает видимость во всех предоставляемых хранилищах данных, используя собственные методы там, где это возможно, или неявную фильтрацию там, где она изначально не поддерживается.  
Метки видимости - это простые логические выражения, основанные на наборе произвольных тегов. Например, вы можете определить два тега: admin и user. Выражением может быть admin, user, admin&user или admin|user, в зависимости от того, как вы хотите предоставить доступ к своим данным. Для более сложных выражений порядок выполнения операций можно использовать в круглых скобках.  
При обратном считывании данных GeoMesa поддерживает концепцию разрешений, чтобы определить, кто что может видеть. Разрешения - это список тегов, соответствующих используемым тегам метки видимости. Например, обычный пользователь может иметь авторизацию user, в то время как пользователь admin может иметь авторизацию admin,user. Авторизации - это простые совпадения строк. Их можно рассматривать как роли, хотя иерархии здесь нет.  
Поскольку разные среды имеют разную архитектуру безопасности, реализация по умолчанию недоступна; пользователи должны предоставить своего собственного поставщика услуг.


## Планирование запросов 

Планирование запросов - это процесс преобразования запроса GeoTools в сканирование и фильтры для конкретного серверного модуля. Планирование запросов в GeoMesa состоит из нескольких этапов:
* Фильтр CQL (если таковой имеется): переписывание и оптимизирование для быстрой оценки
* Фильтр CQL: разделение на части на основе доступных индексов
* Для выполнения запроса выбирается один из доступных индексов
* Логический план запроса создается с помощью основного кода индексации GeoMesa
* Физический план запроса создается для конкретной серверной базы данных

План логического запроса в GeoMesa обычно состоит из "первичного" фильтра CQL, который используется для определения диапазонов сканирования, и "вторичного" фильтра CQL, который применяется к соответствующим строкам. Например, индекс Z2 будет обрабатывать любые пространственные предикаты в качестве диапазонов сканирования, и впоследствии будут применены любые дополнительные фильтры.
На втором этапе планирования запроса полный фильтр декомпозируется и проверяется с учетом доступных индексов. Для каждого индекса будут определены первичный и вторичный фильтры (если таковые имеются).  
Например, рассмотрим фильтр:  
BBOX(geom,0,0,10,10) AND
  dtg DURING 2017-01-01T00:00:00.000Z/2017-01-02T00:00:00.000Z
  AND name = 'Алиса'  
Этот фильтр может быть разложен несколькими способами - для пространственного индекса Z2 первичным фильтром является BBOX, для пространственно-временного индекса Z3 первичным фильтром является BBOX плюс TIME, а для индекса атрибута (при условии, что ‘name’ проиндексировано) первичным фильтром является name = 'alice'.  
Поскольку полный пропуск строк выполняется намного быстрее, чем их чтение и фильтрация, лучшим планом запроса, как правило, будет тот, который сканирует наименьшее количество строк. Другими словами, лучший план - это тот, который имеет наиболее избирательный первичный фильтр. У GeoMesa есть два метода определения наилучшего индекса - cost-based или cost-heuristic. Используемый метод может быть настроен для каждого запроса  
**Cost-based:**  
GeoMesa будет собирать статистику во время добавления данныз и сохранять ее для использования при планировании запросов. Собранная статистика такова:  
* Общее количество
* Минимальное/максимальное значение (границы) для геометрии по умолчанию, даты по умолчанию и любых индексированных атрибутов
* Гистограммы для геометрии по умолчанию, даты по умолчанию и любых индексированных атрибутов
* Частоты для любых индексированных атрибутов с разбивкой по неделям
* Top-k для любых индексированных атрибутов
* Гистограмма Z3, основанная на геометрии по умолчанию и дате по умолчанию (если присутствуют оба параметра)

**Heuristic-based:**  
Эвристика может быть использована для планирования запросов исключительно на основе фильтра запросов. Приоритетами являются:  
* Предикаты идентификатора объекта с использованием индекса идентификатора
* Атрибутивные предикаты высокой мощности, использующие индекс атрибута
*Предикаты равенства атрибутов с использованием индекса атрибута
* Пространственно-временные предикаты, использующие индекс Z3/XZ3
* Предикаты диапазона атрибутов, использующие индекс атрибута
* Пространственные предикаты, использующие индекс Z2/XZ2
* Временные предикаты, использующие индекс Z3/XZ3
* Атрибутивные предикаты малой мощности, использующие индекс атрибута
 
Логирование:  
GeoMesa автоматически логирует планы объяснения во время выполнения запроса. Это может быть полезно при отладке проблем с запросами и может служить основой для принятия решений по ускорению времени выполнения, например, когда добавлять дополнительные индексы или когда могут оказаться полезными подсказки по запросу.

## Распределенная система:
GeoMesa Spark предоставляет возможности для выполнения заданий геопространственного анализа на распределенной крупномасштабной платформе обработки данных Apache Spark. Он предоставляет Spark интерфейсы для приема и анализа геопространственных данных, хранящихся в хранилищах данных GeoMesa.  

// image  

## Методы восстановления
GeoMesa не предоставляет никакого механизма для создания моментального снимка
Но методы восстановления все доступны из тех, что предоставляют базы данных, которые используются под капотом.

## Data Mining, Data Warehousing, OLAP
GeoMesa File System data store (FSDS) предоставляет экономичное и высокопроизводительное решение для масштабного анализа пространственных данных в стиле OLAP с использованием таких фреймворков, как Apache Spark. Он использует современные столбчатые форматы, которые обеспечивают сжатие данных и кодировку на основе столбцов для эффективных OLAP-запросов.  
Mining и Warehousing возможны через базы данных, которые находятся под капотом (информации в интернете именно про Geomesa нет)  


## Общество
Geomesa имеет open sourse код и открыта для дальнейшего развития для каждого:  
Можно написать в user: https://accounts.eclipse.org/mailing-list/geomesa-users или developer: https://accounts.eclipse.org/mailing-list/geomesa-dev почту.  
Так же можно вступить в чат в Gitter: https://gitter.im/locationtech/geomesa  
Кто развивает Geomesa:  
// image   

## Самостоятельное изучение

Весть код находится на гитхаб: https://github.com/locationtech/geomesa, там же есть обучающие туториалы  
Для быстрого старта можно использовать данные и инструкцию, подготовленные для пользователей на официальном сайте: https://www.geomesa.org/documentation/stable/index.html  

## Конференции и курсы  
Различные конференции и презентации http://www.geomesa.org/outreach/  
Неплохое вводное видео про Geomesa: https://www.youtube.com/watch?v=u0ItKDm59SQ  
